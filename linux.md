# Table of Contents
<!-- TOC -->

- [Table of Contents](#table-of-contents)
- [Linux](#linux)
    - [Compile](#compile)
    - [Device Tree](#device-tree)
    - [GCC commands](#gcc-commands)
    - [Compiler symbol extraction](#compiler-symbol-extraction)
    - [Misc](#misc)
- [Yocto](#yocto)
    - [Recipes](#recipes)
    - [bbappend](#bbappend)
        - [Enable new feature](#enable-new-feature)
        - [Pass build flags](#pass-build-flags)
    - [Layers](#layers)
    - [Images](#images)
    - [Misc commands](#misc-commands)
        - [Find out toolchain used by the Yocto](#find-out-toolchain-used-by-the-yocto)
        - [Expand disk size](#expand-disk-size)
- [Buildroot](#buildroot)

<!-- /TOC -->

# Linux

## Compile
- `make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- clean` - Remove object files
- `make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- mrproper` - Remove intermediate files including .config
- `make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- distclean`
- `make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- <defconfig>`
- `make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- menuconfig`
- `make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- zImage`
- `make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- <dt filename>.dtb` - Build an individual dts file
- `make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- dtbs- ` - Build all DTS
- `make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- modules- `
- `sudo make ARCH=arm INSTALL_MOD_PATH=<path to root of file system> modules_install`
 - `INSTALL_MOD_STRIP=1` - Pass it on to strip down debug info from the kernel module


## Device Tree
- [Convert DTS to DTB](https://gist.github.com/aakbar5/60e432b4e16843bef8656de88ab1e1b7)
- [Convert DTB to DTS](https://gist.github.com/aakbar5/60e432b4e16843bef8656de88ab1e1b7)


## GCC commands
- Add `-P -E` to gcc commandline to generate pre-process code for inspection
- Add `-S` to gcc commandline to generate assembly code
- `gcc -dM -E - < /dev/null` - See list of compiler default macros in standard build
- `gcc -dM -E -O0 - < /dev/null` - See list of the compiler default macros with optimization level 0
- `g++ -dM -E -x c++ -std=c++11 - < /dev/null` - Compiler default macros in case of c++11


## Compiler symbol extraction

- `make kernelversion` - To see kernel version.
- `strip --strip-debug </path/to/input/lib/program> -o </path/to/output/file>` - Strip debug info
- `size --common --totals <path/to/obj/file/or/path/to/executable>` - Show sizes of the each section
    ```
    aarch64-poky-linux-size --common --totals vmlinux
    text	   data	    bss	    dec	    hex	filename
    15036748	8039596	 441152	23517496	166d938	vmlinux
    15036748	8039596	 441152	23517496	166d938	(TOTALS)
    ```
- `rm /etc/ld.so.cache && ldconfig` - Force the system to rebuild ld cache

- `nm -S --size-sort -s </path/to/executable/file>` - Getting symbols
- `nm </path/to/c++/library> | c++filt` - Demangles C++ symbols

- `readelf --wide --syms </path/to/.so/file/or/executable/file>` - See all symbols of a .so file
- `readelf --wide --sections </path/to/.so/file/or/executable/file>` - See summary of all sections
- `readelf --file-header </path/to/.so/file/or/executable/file>` - Show header of the ELF file.
                                            -- for so file: TYPE is DYN (Shared object file)

- `readelf libcl.so -W -d | grep NEEDED` - Get list of the external libraries required by the ELF object
- `readelf --all app` -
- `readelf --dynamic app` - Show dynamic sections of the app
- `readelf --header app` - Show the header of the file
- `readelf --headers app | grep 'Entry point'` - Show entry point address
- `readelf --relocs app` - Show relocation sections of the app
- `readelf --segments app` - Show segment headers

- `addr2line -f -e vmlinux 0xDEADBEAF` - Map address onto line in the source code
- `<linux/source>/scripts/faddr2line vmlinux native_write_msr+0x6` - kernel secript to translate a stack dump function

- `objdump -p /path/to/program | grep NEEDED` - Get list of the external libraries required by the ELF object
- `objdump --disassemble ./test | grep 100002b0`
- `objdump --disassemble-all ./hello`
- `objdump --syms ./fuse.ko | grep modinfo`
- `hexdump -C /bin/ls`

- `LD_DEBUG=all /path/to/app` - Can be used to dump debug info generated by the Linux dynamic linker

    ```
    Valid options for the LD_DEBUG environment variable are:

    libs        display library search paths
    reloc       display relocation processing
    files       display progress for input file
    symbols     display symbol table processing
    bindings    display information about symbol binding
    versions    display version dependencies
    all         all previous options combined
    statistics  display relocation statistics
    unused      determined unused DSOs
    help        display this help message and exit
    ```
    Ref: http://schillix.sourceforge.net/man/man1/ld.so.1.1.html


## Misc

- `udevadm control --reload-rules && udevadm trigger` - For udev to reload rules
    - https://marc.info/?l=linux-usb&m=121459435621262&w=2

- Verify config of the running kernel
	- Dump config: `cat /proc/config.gz | gunzip > active_config.config` or `zcat /proc/config.gz > active_config.config`
    - Needs kernel support for this: `General setup > Kernel .config support > Enable access to .config through /proc/config.gz`.

- DRM manipulation via commandline
    - Chanage debug level
        - `cat /sys/module/drm/parameters/debug`
        - `echo 0xff > /sys/module/drm/parameters/debug`
           - `drm.debug=0x1` will enable `CORE` messages
           - `drm.debug=0x2` will enable `DRIVER` messages
           - `drm.debug=0x3` will enable `CORE` and `DRIVER` messages
           - ...
           - `drm.debug=0x1ff` will enable all messages

    - Device status
        - `cat /sys/class/drm/card0-HDMI-A-1/status`
        - `cat /proc/meminfo | grep -i cma`
        - `cat /sys/kernel/debug/dma_buf/bufinfo`
        - `cat /sys/kernel/debug/dri/0/state`

# Yocto
## Recipes

- `bitbake <package-name_OR_recipe_name> -c listtasks` - Show tasks associated for a specific package/recipe.
- `bitbake <package-name_OR_recipe_name> -f -c <task_name>` - `-f` is forcing bitbake to perform the task. `<task_name>` Retrieved from the above command without `do_`.
- `bitbake <package-name_OR_recipe_name> -c devshell` - Open a new shell where build env is setup for a specific package/recipe.
- `bitbake -s | grep <package-name_OR_recipe_name>` - Check if certain package is present on current Yocto Setup
- `bitbake -e <recipe_name> | grep ^PV` - To find out recipe version which will be used to build image
	- To override selection, use `PREFERRED_VERSION_<recipe> = <version>` in your distro or local configuration.

- `bitbake virtual/kernel -c compile` - Build a kernel
- `bitbake virtual/kernel -c menuconfig` - Show menuconfig for the kernel
- `bitbake virtual/kernel -c diffconfig` - Show diff in config
- `bitbake virtual/kernel -c cleanall` - Clean the kernel build

- `bitbake -e virtual/kernel | grep "^PN"` - To find out package providing kernel
- `bitbake -e u-boot | grep "^WORKDIR"` - To find out folder used as working directory

## bbappend

- `bbappend` files can be used to pass-on new configuration to a recipe.

### Enable new feature
- Add features using `bbappend`

Enable features:
```
PACKAGECONFIG ?= "feature1"
PACKAGECONFIG += "feature2"
```

Pass different options as per new features:
```
PACKAGECONFIG[feature1] = "--enable-feature1,--disable-feature1,dependencies"
PACKAGECONFIG[feature2] = "--enable-feature2,--disable-feature2,dependencies
```

### Pass build flags

- Pass new flags to build:
```
EXTRA_OECMAKE += " -DENABLE_MODULE_1=1 -DEXTRA_FLAGS=1"
```

## Layers

- `bitbake-layers show-layers` - Show currently configured layers
- `bitbake-layers show-recipes` - Show all recipes and their versions alongwith the layer
- `bitbake-layers show-recipes <recipe-name>` - Show all recipes and their versions for a specific recipe
		- `PREFERRED_VERSION_<recipe-name>` - To use a specific version.

- `bitbake-layers show-recipes "*-image-*"` - Show recipes to produce image(s).
- `bitbake-layers show-appends ` - Show all .bbappend files and their respective recipes
- `bitbake-layers show-overlayed ` - Show overlayed recipes

## Images

- `bitbake -e <image-name> | grep '^DISTRO_FEATURES'` - Grep value `DISTRO_FEATURES` used to build <image-name>
- `bitbake -e <image-name> | grep '^IMAGE_FSTYPES='` - Grep value `DISTRO_FEATURES` used to build <image-name>
- `bitbake -g <image-name>` - It will produce a couple of files which can be used to extract info related to pulled packages/versions.
- `bitbake -g <image-name> -u depexp` - Show package dependency for <image-name>
- `bitbake -g <image-name> && cat pn-buildlist | sort | uniq` - Show all packages pulled for the <image-name>
- `bitbake -g <image-name> && cat pn-buildlist | grep -ve "native" | sort | uniq` - Show all packages pulled for <image-name> especially for `native`

## Misc commands

### Find out toolchain used by the Yocto
`bitbake -e | grep EXTERNAL_TOOLCHAIN_SYSROOT=`

### Expand disk size
- Create an extra disk space in rootfs.
- Following commands gives 3.7GB of rootfs to fit in a 4GB sdcard.
```
IMAGE_EXTRA_SPACE = "0"
IMAGE_ROOTFS_EXTRA_SPACE = "0"
IMAGE_ROOTFS_SIZE = "3806250"
```

# Buildroot
- `make <package-name>-dirclean` - Clean build of the package # `<package-name>`
- `make <package-name>-rebuild` - Rebuild the package # `<package-name>`
- `make <package-name>-reconfigure` - Reconfigure the package # `<package-name>`
- `make <package-name>-reinstall` - Reinstall the package # `<package-name>` into the rootfs
- `make` - Build all packages and generate rootfs

- `make linux-dirclean` - Clean build folder of the kernel
- `make linux-rebuild` - Rebuild kernel
- `make linux-menuconfig` - Run menuconfiq of the kernel
- `rm -rf </path/to/buildroot/folder>/output/build/linux-*` - Manually remove build artifact related to the kernel
- `rm </path/to/buildroot/folder>/dl/linux-*` - Manually remove download files related to the kernel
